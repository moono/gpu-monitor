<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{ page_title }}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <style>
        /* Adds some space */
        .top-buffer {
            margin-top:20px;
        }

        /* Collapsable div? */
        .panel-heading .accordion-toggle:after {
            /* symbol for "opening" panels */
            /*font-family: 'Glyphicons Halflings';  !* essential for enabling glyphicon *!*/
            content: "\2212";    /* adjust as needed, taken from bootstrap.css */
            float: right;        /* adjust as needed */
            color: grey;         /* adjust as needed */
        }
        .panel-heading .accordion-toggle.collapsed:after {
            /* symbol for "collapsed" panels */
            content: "\002b";    /* adjust as needed, taken from bootstrap.css */
        }

        /*  */
        html {
            font-size: 1rem;
        }

        @media (min-width: 576px) {
            html {
                font-size: 1.25rem;
            }
        }

        @media (min-width: 768px) {
            html {
                font-size: 1.5rem;
            }
        }

        @media (min-width: 992px) {
            html {
                font-size: 1.75rem;
            }
        }

        @media (min-width: 1200px) {
            html {
                font-size: 2rem;
            }
        }
    </style>
</head>


<body>
<div class="container-fluid">
    <!--{% for host_name, data in initial_chart_data %}-->
    <!--<div class="row top-buffer">-->
        <!--&lt;!&ndash; Left space &ndash;&gt;-->
        <!--<div class="col-sm-1 col-md-1 col-lg-1 sidenav">-->
            <!--<h3>{{ host_name }}</h3>-->
        <!--</div>-->

        <!--<div class="col-sm-5 col-md-5 col-lg-5">-->
            <!--<canvas id="barChart_{{ host_name }}"></canvas>-->
        <!--</div>-->
        <!--<div class="col-sm-5 col-md-5 col-lg-5">-->
            <!--<canvas id="pieChart_{{ host_name }}"></canvas>-->
        <!--</div>-->

        <!--&lt;!&ndash; Right space &ndash;&gt;-->
        <!--<div class="col-sm-1 col-md-1 col-lg-1 sidenav">-->
        <!--</div>-->
    <!--</div>-->
    <!--{% endfor %}-->

    <div class="panel-group" id="accordion">
        {% for host_name, data in initial_chart_data %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <!-- use data-parent="#accordion" to default behavior-->
                        <!-- https://stackoverflow.com/questions/22890435/how-do-you-keep-multiple-collapses-open-in-bootstrap-3 -->
                        <a class="accordion-toggle" data-toggle="collapse" href="#collapse_{{ host_name }}">
                        <!--<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapse_{{ host_name }}">-->
                            {{ host_name }}
                        </a>
                    </h4>
                </div>
                <div id="collapse_{{ host_name }}" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <div class="col-sm-6 col-md-6 col-lg-6">
                            <canvas id="barChart_{{ host_name }}"></canvas>
                        </div>
                        <div class="col-sm-6 col-md-6 col-lg-6">
                            <canvas id="pieChart_{{ host_name }}"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Additional library scripts-->
<!-- jquery -->
<script src="{{ url_for('static', filename='js/jquery-3.3.1.min.js') }}"></script>

<!-- Bootstrap core JavaScript -->
<script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>

<!-- Chart.js-->
<script src="{{ url_for('static', filename='chartjs-2.7.3/Chart.min.js') }}"></script>
<script src="{{ url_for('static', filename='chartjs-2.7.3/chartjs-plugin-labels.min.js') }}"></script>

<!-- Custom script -->
<script type="text/javascript">

    const predefinedColors = [
        'rgba(252, 161, 125, 1)',
        'rgba(154, 52, 142, 1)',
        'rgba(232, 219, 125, 1)',
        'rgba(255, 159, 64, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(255,99,132,1)',
        'rgba(75, 192, 192, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(249, 219, 189, 1)',
        'rgba(218, 98, 125, 1)',
        'rgba(85, 140, 140, 1)',
    ];

    function hexToRgb (hex) {
        // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
        let shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
        hex = hex.replace(shorthandRegex, function (m, r, g, b) {
            return r + r + g + g + b + b;
        });

        let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    };

    function createChartjsBarChartData (bar_chart_data) {
        const m_background_color = [];
        const m_border_color = [];
        const u_background_color = [];
        const u_border_color = [];
        for (let i = 0; i < bar_chart_data["labels"].length; i++) {
            m_background_color.push('rgba(54, 162, 235, 0.2)');
            m_border_color.push('rgba(54, 162, 235, 1)');
            u_background_color.push('rgba(255, 99, 132, 0.2)');
            u_border_color.push('rgba(255, 99, 132, 1)');
        }

        // create chart.js data and return
        return {
            labels: bar_chart_data["labels"],
            datasets: [{
                label: 'memory usage %',
                data: bar_chart_data["memory_data"],
                backgroundColor: m_background_color,
                borderColor: m_border_color,
                borderWidth: 1
            }, {
                label: 'utilization %',
                data: bar_chart_data["utilization_data"],
                backgroundColor: u_background_color,
                borderColor: u_border_color,
                borderWidth: 1
            }]
        };
    }

    function createChartjsPieChartData (pie_chart_data) {
        // prepare variables
        const removeFreeMemory = true;
        let labelsData = pie_chart_data["labels"];
        let pointsData = pie_chart_data["processes_data"];
        if (removeFreeMemory) {
            const dataLength = pie_chart_data["labels"].length;
            labelsData = labelsData.slice(0, dataLength - 1);
            pointsData = pointsData.slice(0, dataLength - 1);
        }

        const background_color = [];
        for (let i = 0; i < labelsData.length; i++) {
            let index = i % predefinedColors.length;
            background_color.push(predefinedColors[index]);
        }

        // create chart.js data and return
        return {
            labels: labelsData,
            datasets: [{
                label: labelsData,
                data: pointsData,
                backgroundColor: background_color
            }]
        };
    }

    function updateChart (charts) {
        $.ajax({
            url: '/collect_all',
            type: 'GET',
            contentType: 'application/json; charset=utf-8',
            processData: false, // NEEDED, DON'T OMIT THIS

            success: function (data) {
                // console.log('Success!');
                // set new data for each charts
                for (let i = 0; i < data.length; i++) {
                    const host_name = data[i][0];
                    const bar_chart_data = createChartjsBarChartData(data[i][1]["bar_chart"]);
                    const pie_chart_data = createChartjsPieChartData(data[i][1]["pie_chart"]);

                    const bar_chart = charts[host_name]["bar"];
                    const pie_chart = charts[host_name]["pie"];
                    bar_chart.data = bar_chart_data;
                    pie_chart.data = pie_chart_data;
                    bar_chart.update(0);
                    pie_chart.update(0);
                }
            },
            error: function (data) {
                console.log('Error!!');
            }
        });
    }

    window.onload = function () {
        // get initial data
        const initialChartData = JSON.parse('{{ initial_chart_data | tojson | safe }}');

        // set initial values
        const charts = {};
        for (let i = 0; i < initialChartData.length; i++) {
            const host_name = initialChartData[i][0];
            const barElementID = "barChart_" + host_name;
            const pieElementID = "pieChart_" + host_name;
            const bar_chart_data = createChartjsBarChartData(initialChartData[i][1]["bar_chart"]);
            const pie_chart_data = createChartjsPieChartData(initialChartData[i][1]["pie_chart"]);

            // create bar charts and save
            charts[host_name] = {};
            const bar_ctx = document.getElementById(barElementID).getContext('2d');
            charts[host_name]["bar"] = new Chart(bar_ctx, {
                // type: 'horizontalBar',
                type: 'bar',
                data: bar_chart_data,
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                max: 100,
                                //min: 0,
                                stepSize: 10
                            },
                            gridLines: {
                                offsetGridLines: true
                            }
                        }]
                    },
                    plugins: {
                        labels: {
                            render: 'value'
                        }
                    }
                }
            });

            const pie_ctx = document.getElementById(pieElementID).getContext('2d');
            charts[host_name]["pie"] = new Chart(pie_ctx, {
                // type: 'polarArea',
                type: 'doughnut',
                // type: 'pie',
                data: pie_chart_data,
                options: {
                    plugins: {
                        labels: [
                            {
                              render: 'label',
                              fontColor: '#000',
                              fontStyle: 'bold',
                              arc: false,
                              position: 'outside'
                            },
                            {
                              render: 'percentage',
                              fontColor: '#000',
                              fontStyle: 'bold',
                              textShadow: true,
                              precision: 2
                            }
                        ]
                    }
                }
            });
        }
        // console.log("break point..");

        setInterval(function () {
            updateChart(charts)
        }, 1000);
    }

</script>

</body>
</html>
